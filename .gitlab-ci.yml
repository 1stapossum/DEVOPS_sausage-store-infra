variables:
  VERSION: 1.0.${CI_PIPELINE_ID}

stages:
  - deploy

sausage-store-deploy:
  image: alpine:3.15.0
  stage: deploy
#  when: manual
  before_script:
    - apk add --no-cache curl
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
    - cp kubectl /usr/local/bin/
    - chmod +x /usr/local/bin/kubectl
    - echo "$KUBECONFIG" >> kubeconfig
  script:
    - kubectl  apply -f kubernetes/backend/ --kubeconfig=kubeconfig
    - kubectl  apply -f kubernetes/backend-report/ --kubeconfig=kubeconfig
    - kubectl  apply -f kubernetes/frontend/ --kubeconfig=kubeconfig
    - rm -f kubeconfig
  rules:
    - changes:
      - kubernetes/**/*
      - .gitlab-ci.yml
  environment:
     name: PRODUCTION
     url: https://02-aleksandr-volokhov.k8s.praktikum-services.tech/
